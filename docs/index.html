<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>rawsql-ts CDN Demo</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2rem;
        }

        textarea {
            width: 100%;
            height: 100px;
        }

        pre {
            background: #f4f4f4;
            padding: 1em;
        }

        .result {
            margin-top: 1em;
        }

        /* --- GitHub icon and h1 alignment fix --- */
        .github-link {
            display: inline-flex;
            align-items: center;
            height: 1em;
            margin-left: 0.5em;
            vertical-align: middle;
            text-decoration: none;
        }

        .github-link svg {
            display: block;
            height: 1.0em;
            width: 1.0em;
            fill: #000;
        }

        /* ---------------------------------------- */
    </style>
</head>

<body>
    <h1 style="display: flex; align-items: center; gap: 0.5em;">
        rawsql-ts
        <!-- GitHub icon and link -->
        <a href="https://github.com/mk3008/rawsql-ts" target="_blank" class="github-link"
            aria-label="GitHub Repository">
            <svg viewBox="0 0 16 16" aria-hidden="true">
                <!-- GitHub Mark SVG Path -->
                <path
                    d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.01.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.11.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.19 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z" />
            </svg>
        </a>
    </h1>
    <!-- Installation section with npm link -->
    <!-- This section provides installation instructions and links 'npm' to the official package page. -->
    <section style="margin-bottom: 1.5em;">
        <h2 style="font-size:1.1em; margin-bottom:0.3em;">Installation</h2>
        <div style="font-size:0.98em;">
            <a href="https://www.npmjs.com/package/rawsql-ts" target="_blank"
                style="color:#cb3837; font-weight:bold; text-decoration:none;">npm</a> install rawsql-ts
        </div>
    </section>
    <p>Type your SQL below and see the formatted and analyzed result using <b>rawsql-ts</b> from CDN!</p>
    <textarea id="sql-input">SELECT u.user_id, u.user_name FROM users as u WHERE u.active = true</textarea>
    <br>
    <button id="run-btn">Analyze SQL</button>
    <div class="result">
        <h2>Formatted SQL</h2>
        <pre id="output"></pre>
        <h2>Select Values</h2>
        <pre id="select-values"></pre>
        <h2>Selectable Columns</h2>
        <pre id="selectable-columns"></pre>
        <h2>Table Sources</h2>
        <pre id="table-sources"></pre>
        <h2>CTEs (Common Tables)</h2>
        <pre id="ctes"></pre>
    </div>
    <script type="module">
        import { SelectQueryParser, Formatter, SelectValueCollector, SelectableColumnCollector, TableSourceCollector, CTECollector } from "https://unpkg.com/rawsql-ts/dist/esm/index.js";
        const input = document.getElementById('sql-input');
        const output = document.getElementById('output');
        const btn = document.getElementById('run-btn');
        const selectValuesEl = document.getElementById('select-values');
        const selectableColumnsEl = document.getElementById('selectable-columns');
        const tableSourcesEl = document.getElementById('table-sources');
        const ctesEl = document.getElementById('ctes');

        // Debounce timer for auto-format
        let debounceTimer = null;
        const DEBOUNCE_DELAY = 750; // ms

        /**
         * Format and analyze the SQL in the textarea and display the results.
         */
        function analyzeSql() {
            // Clear previous results
            output.textContent = '';
            selectValuesEl.textContent = '';
            selectableColumnsEl.textContent = '';
            tableSourcesEl.textContent = '';
            ctesEl.textContent = '';

            // Format SQL
            try {
                const query = SelectQueryParser.parse(input.value);
                const formatter = new Formatter();
                try {
                    output.textContent = formatter.format(query);
                } catch (e) {
                    output.textContent = '[Formatter Error] ' + e.message;
                }

                // Select values
                try {
                    const selectValueCollector = new SelectValueCollector();
                    const selectValues = selectValueCollector.collect(query);
                    selectValuesEl.textContent = selectValues.map(val => `name: ${val.name}, value: ${formatter.format(val.value)}`).join('\n');
                } catch (e) {
                    selectValuesEl.textContent = '[SelectValueCollector Error] ' + e.message;
                }

                // Selectable columns
                try {
                    const selectableColumnCollector = new SelectableColumnCollector();
                    const selectableColumns = selectableColumnCollector.collect(query);
                    selectableColumnsEl.textContent = selectableColumns.map(val => `name: ${val.name}, value: ${formatter.format(val.value)}`).join('\n');
                } catch (e) {
                    selectableColumnsEl.textContent = '[SelectableColumnCollector Error] ' + e.message;
                }

                // Table sources
                try {
                    const tableSourceCollector = new TableSourceCollector(false);
                    const sources = tableSourceCollector.collect(query);
                    tableSourcesEl.textContent = sources.map(src => `name: ${src.getSourceName()}`).join('\n');
                } catch (e) {
                    tableSourcesEl.textContent = '[TableSourceCollector Error] ' + e.message;
                }

                // CTEs (Common Tables)
                try {
                    const cteCollector = new CTECollector();
                    cteCollector.visit(query);
                    const ctes = cteCollector.getCommonTables();
                    ctesEl.textContent = ctes.map(cte => `name: ${cte.getAliasSourceName()}, query: ${formatter.format(cte.query)}`).join('\n');
                } catch (e) {
                    ctesEl.textContent = '[CTECollector Error] ' + e.message;
                }
            } catch (e) {
                output.textContent = '[Parse Error] ' + e.message;
            }
        }

        // Button click: manual analyze
        btn.onclick = analyzeSql;

        // Auto-analyze after user stops typing
        input.addEventListener('input', () => {
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(analyzeSql, DEBOUNCE_DELAY);
        });

        // Run once on load
        analyzeSql();
    </script>
</body>

</html>