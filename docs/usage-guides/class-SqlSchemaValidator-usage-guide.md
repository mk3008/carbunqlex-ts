# SqlSchemaValidator Usage Guide

The `SqlSchemaValidator` class is a utility designed to validate SQL queries against a predefined database schema. It helps ensure that queries are syntactically correct and reference valid tables and columns, preventing potential runtime errors and enhancing query reliability.

## Key Features

*   **Schema Validation**: Validates SQL queries based on a provided schema definition.
*   **Table and Column Verification**: Checks for the existence of tables and columns referenced in the query.
*   **Alias Aware**: Understands and correctly resolves table aliases used in queries.
*   **Error Reporting**: Provides clear error messages indicating the nature and location of validation failures.

## How It Works

`SqlSchemaValidator` parses the input SQL query into an Abstract Syntax Tree (AST). It then traverses this AST, comparing the tables and columns found in the query against the schema provided during its instantiation.

The schema should be an object where keys are table names, and values are arrays of column names for that table.

## Basic Usage

Here's a simple example of how to use `SqlSchemaValidator`:

```typescript
import { SqlSchemaValidator, SelectQueryParser } from 'rawsql-ts';

// Define your database schema
const schema = {
  users: ['user_id', 'user_name', 'email', 'status'],
  orders: ['order_id', 'user_id', 'order_date', 'total_amount']
};

// Instantiate the validator with the schema
const validator = new SqlSchemaValidator(schema);

// Example 1: A valid query
const validSql = 'SELECT u.user_id, u.user_name FROM users as u WHERE u.status = \'active\'';
const parser = new SelectQueryParser();
try {
  const ast = parser.parse(validSql);
  validator.validate(ast);
  console.log('Valid query!');
} catch (error) {
  console.error('Validation failed:', error.message);
}
// Output: Valid query!

// Example 2: An invalid query (non-existent column)
const invalidSqlColumn = 'SELECT user_id, non_existent_column FROM users';
try {
  const ast = parser.parse(invalidSqlColumn);
  validator.validate(ast);
  console.log('Valid query!');
} catch (error) {
  console.error('Validation failed:', error.message);
}
// Output: Validation failed: Column 'non_existent_column' not found in table 'users'.

// Example 3: An invalid query (non-existent table)
const invalidSqlTable = 'SELECT product_name FROM products';
try {
  const ast = parser.parse(invalidSqlTable);
  validator.validate(ast);
  console.log('Valid query!');
} catch (error) {
  console.error('Validation failed:', error.message);
}
// Output: Validation failed: Table 'products' not found in schema.
```

## Schema Definition

The schema object should follow this structure:

```typescript
const schema = {
  tableName1: ['column1', 'column2', 'column3'],
  tableName2: ['columnA', 'columnB'],
  // ... more tables
};
```

## Validation Process

When the `validate` method is called with an AST (typically generated by a parser like `SelectQueryParser`):

1.  **Table Validation**: It checks if all tables mentioned in the `FROM` clause (and `JOIN` clauses) exist in the provided schema.
2.  **Column Validation**: For each selected column, or columns used in `WHERE`, `GROUP BY`, `ORDER BY`, etc., it verifies that the column exists in the corresponding table (or its alias) as defined in the schema.
3.  **Alias Resolution**: It correctly handles table aliases. For example, in `SELECT u.user_name FROM users as u`, it knows that `u` refers to the `users` table.

## Error Handling

If validation fails, `SqlSchemaValidator` throws an error with a descriptive message. This message typically includes:

*   The type of error (e.g., table not found, column not found).
*   The name of the table or column that caused the error.

This allows developers to quickly identify and fix issues in their SQL queries.

## Use Cases

*   **Pre-execution Check**: Validate queries before sending them to the database to catch errors early.
*   **Dynamic Query Building**: Ensure that dynamically constructed queries adhere to the schema.
*   **Query Builders/ORMs**: Integrate into higher-level query building tools to provide an extra layer of safety.
*   **Educational Tools**: Help users learn SQL by providing immediate feedback on schema adherence.

By using `SqlSchemaValidator`, you can significantly improve the robustness of your application's database interactions.
