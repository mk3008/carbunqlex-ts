# Prisma Comparison Demo

A comprehensive demonstration environment showcasing the capabilities of `@rawsql-ts/prisma-integration` compared to traditional Prisma ORM approaches.

## 🎯 What This Demo Shows

This project demonstrates:
- **Side-by-side comparison** between Prisma ORM and RawSqlClient approaches
- **Real-world SQL queries** with complex joins and aggregations
- **JSON mapping capabilities** for hierarchical data structures
- **Static analysis validation** of SQL files against Prisma schema
- **Type-safe development** with TypeScript integration
- **Complete development workflow** from setup to testing

## 🏗️ Project Structure

```
prisma-comparison-demo/
├── prisma/
│   ├── schema.prisma          # Database schema definition
│   ├── seed.ts                # Sample data seeding
│   └── sql/                   # Raw SQL queries for comparison
│       ├── getTodoDetail.sql
│       ├── searchTodos.sql
│       └── ...
├── rawsql-ts/                 # RawSqlClient SQL files
│   ├── getTodoDetail.sql      # Enhanced version with JSON mapping
│   ├── getTodoDetail.json     # JSON transformation mapping
│   ├── searchTodos.sql
│   ├── searchTodos.json
│   └── ...
├── src/
│   ├── contracts/             # TypeScript interfaces and types
│   ├── interfaces/            # Domain model definitions
│   ├── services/              # Business logic services
│   └── test-runners/          # Comparison test implementations
├── tests/
│   └── sql-static-analysis.test.ts  # Static validation tests
├── reports/                   # Generated analysis reports
└── docker-compose.yml         # PostgreSQL setup
```

## 🚀 Quick Start

### Prerequisites

- Node.js 18+ and npm
- Docker and Docker Compose (for PostgreSQL)
- VS Code (recommended for SQL editing)

### 1. Clone and Setup

```bash
git clone <repository-url>
cd rawsql-ts/examples/prisma-comparison-demo

# Install dependencies
npm install
```

### 2. Configure Environment

Create a `.env` file in the project root with the following content:

```bash
# Database connection for Docker PostgreSQL
DATABASE_URL="postgresql://demo_user:demo_password@localhost:5432/prisma_comparison_demo?schema=public"
```

> **Note**: These credentials match the Docker Compose configuration. Adjust if you use different settings.

### 3. Start Database

```bash
# Start PostgreSQL with Docker
docker-compose up -d

# Wait a few seconds for PostgreSQL to initialize
```

### 4. Initialize Database

```bash
# Run Prisma migrations
npx prisma migrate dev

# Seed with sample data
npx prisma db seed

# Generate Prisma client
npx prisma generate
```

### 5. Verify Setup

```bash
# Run static analysis to validate SQL files
npm run test:sql

# Expected output:
# ✅ All SQL files validated successfully!
```

### 6. Explore the Demo

```bash
# Run the main comparison demo (shows both Prisma and rawsql-ts approaches)
npm run test

# Alternative ways to run the demo
npm run dev    # Development mode with detailed output
npm run start  # Same as npm run test
```

> **What does `npm run test` do?**
> 
> This command runs a comprehensive comparison between Prisma ORM and rawsql-ts approaches:
> - **Search Tests**: Compares different search scenarios (by title, completion status, user, category, etc.)
> - **Detail Tests**: Compares retrieval of complex nested data structures
> - **Performance Analysis**: Captures SQL execution details, query strategies, and performance metrics
> - **Report Generation**: Creates detailed Markdown reports in the `reports/` folder
> - **Live SQL Logging**: Shows actual SQL queries generated by both approaches
> 
> The demo executes the same business logic using both Prisma ORM and rawsql-ts, allowing you to see the differences in:
> - Generated SQL complexity
> - Query execution strategies
> - Data transformation approaches
> - Performance characteristics

## 📊 Demo Scenarios

### Scenario 1: Basic Data Retrieval

**Prisma ORM Approach:**
```typescript
// Traditional Prisma with includes
const todoWithRelations = await prisma.todo.findUnique({
  where: { id: todoId },
  include: {
    user: true,
    category: true,
    comments: {
      include: {
        user: true
      }
    }
  }
});
```

**RawSqlClient Approach:**
```typescript
// Single query with JSON mapping
const todoDetail = await rawSqlClient.queryOne<TodoDetail>(
  'getTodoDetail.sql', 
  { todoId }
);
```

### Scenario 2: Complex Search Queries

**Prisma ORM Approach:**
```typescript
// Multiple separate queries or complex where conditions
const todos = await prisma.todo.findMany({
  where: {
    AND: [
      { title: { contains: searchTerm } },
      { completed: false },
      { user: { department: 'Engineering' } }
    ]
  },
  include: { user: true, category: true }
});
```

**RawSqlClient Approach:**
```typescript
// Dynamic query with filters
const searchResults = await rawSqlClient.queryMany<TodoSearchResult>(
  'searchTodos.sql',
  {
    filter: {
      title: { ilike: `%${searchTerm}%` },
      completed: false,
      'user.department': 'Engineering'
    },
    sort: { created_at: { desc: true } },
    paging: { page: 1, pageSize: 20 }
  }
);
```

### Scenario 3: Analytics and Aggregations

**Prisma ORM Approach:**
```typescript
// Multiple queries needed for complex aggregations
const userStats = await prisma.user.findUnique({
  where: { id: userId },
  include: {
    _count: {
      select: {
        todos: true,
        comments: true
      }
    }
  }
});

const avgRating = await prisma.todo.aggregate({
  where: { userId },
  _avg: { rating: true }
});
```

**RawSqlClient Approach:**
```typescript
// Single complex query with all aggregations
const userAnalytics = await rawSqlClient.queryOne<UserAnalytics>(
  'getUserAnalytics.sql',
  { userId }
);
```

## 🔍 Exploring SQL Files

### Basic SQL Query Structure

```sql
-- rawsql-ts/getTodoDetail.sql
SELECT 
    t.todo_id, t.title, t.description, t.completed, t.created_at,
    u.user_id, u.user_name, u.email,
    c.category_id, c.category_name, c.color,
    tc.comment_id, tc.comment_text, 
    tc.created_at as comment_created_at,
    cu.user_name as comment_user_name
FROM todo t
INNER JOIN "user" u ON t.user_id = u.user_id
INNER JOIN category c ON t.category_id = c.category_id
LEFT JOIN todo_comment tc ON t.todo_id = tc.todo_id
LEFT JOIN "user" cu ON tc.user_id = cu.user_id
WHERE t.todo_id = $1
ORDER BY tc.created_at ASC
```

### JSON Mapping Configuration

```json
// rawsql-ts/getTodoDetail.json
{
  "rootEntity": {
    "columns": {
      "todoId": "todo_id",
      "title": "title",
      "description": "description",
      "completed": "completed",
      "createdAt": "created_at"
    }
  },
  "nestedEntities": [
    {
      "propertyName": "user",
      "relationshipType": "object",
      "columns": {
        "userId": "user_id",
        "userName": "user_name",
        "email": "email"
      }
    },
    {
      "propertyName": "category",
      "relationshipType": "object",
      "columns": {
        "categoryId": "category_id",
        "categoryName": "category_name",
        "color": "color"
      }
    },
    {
      "propertyName": "comments",
      "relationshipType": "array",
      "columns": {
        "commentId": "comment_id",
        "commentText": "comment_text",
        "createdAt": "comment_created_at",
        "userName": "comment_user_name"
      }
    }
  ]
}
```

## 🧪 Testing and Validation

### Static Analysis

```bash
# Validate all SQL files against Prisma schema
npm run test:sql

# Watch mode for continuous validation during development
npm run test:sql:watch
```

### Performance Testing & Integration

```bash
# Run the comprehensive comparison demo
npm run test

# This includes:
# - Search functionality tests  
# - Detail retrieval tests
# - Performance analysis with SQL execution details
# - Report generation in the reports/ folder
```

## 🎮 Interactive Exploration

### Available Commands

Here are all the commands you can use in this demo:

| Command | Description |
|---------|-------------|
| `npm run test` | Run the main comparison demo with detailed analysis |
| `npm run dev` | Same as test, but in development mode |
| `npm run start` | Alternative way to run the comparison demo |
| `npm run test:sql` | Validate all SQL files against Prisma schema |
| `npm run test:sql:watch` | Run SQL validation in watch mode |
| `npm run build` | Compile TypeScript to JavaScript |
| `npm run generate` | Generate Prisma client |
| `npm run db:setup` | Start PostgreSQL, apply schema, and seed data |
| `npm run db:reset` | Reset database and re-seed with fresh data |
| `npm run db:stop` | Stop the PostgreSQL Docker container |

### VS Code Integration

1. **Install recommended extensions:** PostgreSQL and Prisma for better SQL editing experience
2. **Open SQL files directly:** Browse `rawsql-ts/` folder and edit SQL queries with real-time validation
3. **Database connection details:**
   - Host: localhost, Port: 5432
   - Database: prisma_comparison_demo
   - Username: demo_user, Password: demo_password

### Customizing the Demo

#### Adding New Queries

1. Create a new `.sql` file in `rawsql-ts/`
2. Create corresponding `.json` mapping file
3. Add TypeScript interface in `src/contracts/`
4. Test with `await rawSqlClient.queryMany<YourType>('yourQuery.sql')`

#### Modifying Sample Data

```bash
# Edit the seed file and re-seed
code prisma/seed.ts
npx prisma db seed
```

## 🔧 Troubleshooting

**Database connection failed:**
```bash
docker-compose ps                    # Check if PostgreSQL is running
docker-compose restart postgres      # Restart PostgreSQL
```

**Prisma client outdated:**
```bash
npx prisma generate                  # Regenerate Prisma client
```

**SQL validation errors:**
```bash
npm run test:sql                     # Check detailed error messages
npm run test:sql:watch              # Run in watch mode for real-time validation
```

## 📚 Learning Resources

1. **[Prisma Integration Guide](../../packages/prisma-integration/README.md)** - Complete documentation
2. **[Usage Guides](../../docs/usage-guides/)** - Detailed guides for specific features
3. **Check the reports folder** - Generated analysis reports with detailed insights

---

**Ready to explore?** Start with `npm run test` to see the comprehensive comparison demo in action! 🚀